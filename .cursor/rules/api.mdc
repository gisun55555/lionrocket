# 🚀 AI 채팅 서비스 API 명세서

## 📋 목차
- [개요](#개요)
- [인증](#인증)
- [기본 응답 형식](#기본-응답-형식)
- [에러 코드](#에러-코드)
- [API 엔드포인트](#api-엔드포인트)
  - [인증 API](#인증-api)
  - [캐릭터 API](#캐릭터-api)
  - [파일 업로드 API](#파일-업로드-api)
  - [메시지 API](#메시지-api)

## 📖 개요

이 API는 AI 캐릭터와 대화할 수 있는 채팅 서비스를 제공합니다.

- **Base URL**: `http://localhost:3001/api`
- **Content-Type**: `application/json`
- **Authentication**: JWT Bearer Token

## 🔐 인증

대부분의 API는 JWT 토큰 인증이 필요합니다.

### 헤더 형식
```http
Authorization: Bearer {your-jwt-token}
```

### 토큰 만료
- **만료 시간**: 1시간
- **만료 시 응답**: `401 Unauthorized`

## 📄 기본 응답 형식

### 성공 응답
```json
{
  "success": true,
  "message": "작업이 성공적으로 완료되었습니다",
  "data": { /* 응답 데이터 */ }
}
```

### 실패 응답
```json
{
  "success": false,
  "message": "오류 메시지",
  "error": "상세 오류 정보 (개발 모드에서만)"
}
```

## ⚠️ 에러 코드

| 상태 코드 | 설명 | 해결 방법 |
|-----------|------|-----------|
| `400` | 잘못된 요청 | 요청 데이터 검증 |
| `401` | 인증 실패 | 토큰 재발급 |
| `403` | 권한 없음 | 접근 권한 확인 |
| `404` | 리소스 없음 | 올바른 ID 확인 |
| `409` | 중복 데이터 | 고유값 중복 검사 |
| `413` | 파일 크기 초과 | 5MB 이하 파일 사용 |
| `422` | 검증 실패 | 입력 데이터 형식 확인 |
| `500` | 서버 오류 | 서버 관리자 문의 |

---

# 🔗 API 엔드포인트

## 🔐 인증 API

### 1. 회원가입
```http
POST /api/auth/register
```

**요청 본문**
```json
{
  "email": "user@example.com",
  "password": "password123",
  "name": "홍길동"
}
```

**검증 규칙**
- `email`: 유효한 이메일 형식
- `password`: 8-100자
- `name`: 2-50자, 한글/영문/공백만 허용

**응답 (201)**
```json
{
  "success": true,
  "message": "회원가입이 완료되었습니다",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_123",
      "email": "user@example.com",
      "name": "홍길동"
    }
  }
}
```

### 2. 로그인
```http
POST /api/auth/login
```

**요청 본문**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**응답 (200)**
```json
{
  "success": true,
  "message": "로그인되었습니다",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_123",
      "email": "user@example.com",
      "name": "홍길동"
    }
  }
}
```

### 3. 로그아웃
```http
POST /api/auth/logout
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "message": "로그아웃되었습니다"
}
```

### 4. 내 정보 조회
```http
GET /api/auth/me
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "id": "user_123",
    "email": "user@example.com",
    "name": "홍길동"
  }
}
```

### 5. 이메일 중복 확인
```http
GET /api/auth/check-email?email=user@example.com
```

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "exists": false,
    "message": "사용 가능한 이메일입니다"
  }
}
```

---

## 🎭 캐릭터 API

### 1. 기본 캐릭터 조회
```http
GET /api/characters/default
```

**응답 (200)**
```json
{
  "success": true,
  "data": [
    {
      "id": "char_001",
      "name": "지혜로운 마법사",
      "prompt": "당신은 고대의 지혜를 가진 마법사입니다...",
      "thumbnail": "/uploads/2024/01/wizard.jpg",
      "isDefault": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

### 2. 모든 캐릭터 조회 (기본 + 공개 사용자 캐릭터)
```http
GET /api/characters
```

**응답 (200)**
```json
{
  "success": true,
  "data": [
    {
      "id": "char_001",
      "name": "지혜로운 마법사",
      "prompt": "당신은 고대의 지혜를 가진 마법사입니다...",
      "thumbnail": "/uploads/2024/01/wizard.jpg",
      "isDefault": true,
      "userId": null,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

### 3. 내 캐릭터 조회
```http
GET /api/characters/user
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "data": [
    {
      "id": "char_user_001",
      "name": "내 로봇 친구",
      "prompt": "당신은 친근하고 도움이 되는 로봇입니다...",
      "thumbnail": "/uploads/2024/01/robot.jpg",
      "isDefault": false,
      "userId": "user_123",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

### 4. 캐릭터 상세 조회
```http
GET /api/characters/{characterId}
```

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "id": "char_001",
    "name": "지혜로운 마법사",
    "prompt": "당신은 고대의 지혜를 가진 마법사입니다...",
    "thumbnail": "/uploads/2024/01/wizard.jpg",
    "isDefault": true,
    "userId": null,
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 5. 캐릭터 생성
```http
POST /api/characters
```
**인증 필요**: ✅

**요청 본문**
```json
{
  "name": "내 로봇 친구",
  "prompt": "당신은 친근하고 도움이 되는 로봇입니다. 항상 긍정적이고 유머러스하게 대화하세요.",
  "thumbnail": "/uploads/2024/01/robot.jpg"
}
```

**검증 규칙**
- `name`: 2-50자
- `prompt`: 10-1000자
- `thumbnail`: 선택사항, 유효한 이미지 URL

**응답 (201)**
```json
{
  "success": true,
  "message": "캐릭터가 생성되었습니다",
  "data": {
    "id": "char_user_001",
    "name": "내 로봇 친구",
    "prompt": "당신은 친근하고 도움이 되는 로봇입니다...",
    "thumbnail": "/uploads/2024/01/robot.jpg",
    "isDefault": false,
    "userId": "user_123",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 6. 캐릭터 수정
```http
PUT /api/characters/{characterId}
```
**인증 필요**: ✅

**요청 본문**
```json
{
  "name": "업데이트된 로봇 친구",
  "prompt": "더 발전된 로봇입니다...",
  "thumbnail": "/uploads/2024/01/new_robot.jpg"
}
```

**응답 (200)**
```json
{
  "success": true,
  "message": "캐릭터가 수정되었습니다",
  "data": {
    "id": "char_user_001",
    "name": "업데이트된 로봇 친구",
    "prompt": "더 발전된 로봇입니다...",
    "thumbnail": "/uploads/2024/01/new_robot.jpg",
    "isDefault": false,
    "userId": "user_123",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T10:30:00.000Z"
  }
}
```

### 7. 캐릭터 삭제
```http
DELETE /api/characters/{characterId}
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "message": "캐릭터가 삭제되었습니다"
}
```

### 8. 캐릭터 이름 중복 확인
```http
GET /api/characters/check-name?name=로봇친구
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "exists": false,
    "message": "사용 가능한 이름입니다"
  }
}
```

---

## 📁 파일 업로드 API

### 1. 이미지 업로드
```http
POST /api/upload/image
Content-Type: multipart/form-data
```
**인증 필요**: ✅

**요청 본문 (FormData)**
```javascript
const formData = new FormData();
formData.append('image', file);
```

**파일 제한사항**
- **크기**: 최대 5MB
- **형식**: PNG, JPEG, WEBP, AVIF
- **검증**: 매직넘버 체크

**응답 (201)**
```json
{
  "success": true,
  "message": "파일이 업로드되었습니다",
  "data": {
    "filename": "abc123def456.jpg",
    "url": "/uploads/2024/01/abc123def456.jpg",
    "size": 2048576,
    "mimetype": "image/jpeg"
  }
}
```

### 2. 이미지 미리보기
```http
POST /api/upload/preview
Content-Type: multipart/form-data
```

**요청 본문 (FormData)**
```javascript
const formData = new FormData();
formData.append('image', file);
```

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "preview": "data:image/jpeg;base64,/9j/4AAQSkZJRgABA..."
  }
}
```

### 3. 이미지 삭제
```http
DELETE /api/upload/image
```
**인증 필요**: ✅

**요청 본문**
```json
{
  "filename": "abc123def456.jpg"
}
```

**응답 (200)**
```json
{
  "success": true,
  "message": "파일이 삭제되었습니다"
}
```

---

## 💬 메시지 API

### 1. 메시지 전송 (AI 응답 자동 생성)
```http
POST /api/messages/send
```
**인증 필요**: ✅

**요청 본문**
```json
{
  "content": "안녕하세요! 오늘 날씨가 좋네요.",
  "characterId": "char_001"
}
```

**검증 규칙**
- `content`: 1-200자
- `characterId`: 유효한 캐릭터 ID

**응답 (201)**
```json
{
  "success": true,
  "message": "메시지가 전송되었습니다",
  "data": {
    "userMessage": {
      "id": "msg_001",
      "content": "안녕하세요! 오늘 날씨가 좋네요.",
      "isUser": true,
      "userId": "user_123",
      "characterId": "char_001",
      "createdAt": "2024-01-01T10:00:00.000Z"
    },
    "aiMessage": {
      "id": "msg_002",
      "content": "안녕하세요! 정말 화창한 날씨네요. 이런 날에는 산책을 하면 기분이 좋을 것 같아요.",
      "isUser": false,
      "userId": "user_123",
      "characterId": "char_001",
      "createdAt": "2024-01-01T10:00:01.000Z"
    }
  }
}
```

### 2. 캐릭터별 대화 히스토리 조회
```http
GET /api/messages/conversations/{characterId}?page=1&limit=50
```
**인증 필요**: ✅

**쿼리 파라미터**
- `page`: 페이지 번호 (기본값: 1)
- `limit`: 페이지당 메시지 수 (기본값: 50, 최대: 100)

**응답 (200)**
```json
{
  "success": true,
  "data": {
    "characterId": "char_001",
    "characterName": "지혜로운 마법사",
    "messages": [
      {
        "id": "msg_001",
        "content": "안녕하세요! 오늘 날씨가 좋네요.",
        "isUser": true,
        "userId": "user_123",
        "characterId": "char_001",
        "createdAt": "2024-01-01T10:00:00.000Z"
      },
      {
        "id": "msg_002",
        "content": "안녕하세요! 정말 화창한 날씨네요.",
        "isUser": false,
        "userId": "user_123",
        "characterId": "char_001",
        "createdAt": "2024-01-01T10:00:01.000Z"
      }
    ],
    "totalMessages": 2
  }
}
```

### 3. 모든 캐릭터의 대화 목록 조회
```http
GET /api/messages/conversations
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "data": [
    {
      "characterId": "char_001",
      "characterName": "지혜로운 마법사",
      "messages": [
        {
          "id": "msg_002",
          "content": "안녕하세요! 정말 화창한 날씨네요.",
          "isUser": false,
          "userId": "user_123",
          "characterId": "char_001",
          "createdAt": "2024-01-01T10:00:01.000Z"
        }
      ],
      "totalMessages": 2
    }
  ]
}
```

### 4. 캐릭터별 대화 삭제
```http
DELETE /api/messages/conversations/{characterId}
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "message": "대화가 삭제되었습니다"
}
```

### 5. 특정 메시지 삭제
```http
DELETE /api/messages/{messageId}
```
**인증 필요**: ✅

**응답 (200)**
```json
{
  "success": true,
  "message": "메시지가 삭제되었습니다"
}
```

---

## 🔗 프론트엔드 연동 예시

### React Hook 예시

```typescript
// API 클라이언트 설정
const API_BASE_URL = 'http://localhost:3001/api';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// 토큰 인터셉터
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// 로그인 Hook
const useLogin = () => {
  return useMutation({
    mutationFn: async (credentials: LoginData) => {
      const response = await apiClient.post('/auth/login', credentials);
      return response.data;
    },
    onSuccess: (data) => {
      localStorage.setItem('token', data.data.token);
    },
  });
};

// 메시지 전송 Hook
const useSendMessage = () => {
  return useMutation({
    mutationFn: async (messageData: SendMessageData) => {
      const response = await apiClient.post('/messages/send', messageData);
      return response.data;
    },
  });
};

// 캐릭터 목록 Hook
const useCharacters = () => {
  return useQuery({
    queryKey: ['characters'],
    queryFn: async () => {
      const response = await apiClient.get('/characters');
      return response.data.data;
    },
  });
};
```

---

## 📝 참고사항

### 개발 팁
1. **토큰 만료 처리**: 401 응답 시 자동 로그아웃 구현
2. **파일 업로드**: FormData 사용, 미리보기 기능 활용
3. **실시간 업데이트**: 메시지 전송 후 대화 목록 새로고침
4. **에러 처리**: 각 API별 적절한 사용자 알림 구현

### 보안 고려사항
1. **토큰 저장**: 메모리 우선, localStorage는 "기억하기" 옵션에만
2. **파일 업로드**: 클라이언트 사이드 검증도 추가 구현
3. **HTTPS**: 프로덕션 환경에서는 반드시 HTTPS 사용
4. **CORS**: 허용된 도메인에서만 API 접근 가능

### 성능 최적화
1. **페이지네이션**: 대화 히스토리는 무한 스크롤 구현
2. **이미지 캐싱**: 썸네일 이미지 브라우저 캐싱 활용
3. **API 호출 최적화**: React Query 등을 활용한 캐싱
4. **파일 압축**: 이미지 업로드 전 클라이언트 사이드 압축

---

📅 **문서 버전**: 1.0.0  
🗓️ **최종 업데이트**: 2024년 1월 1일  
👨‍💻 **작성자**: 라이언로켓 개발팀